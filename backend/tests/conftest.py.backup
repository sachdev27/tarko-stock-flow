"""
Pytest configuration and shared fixtures for test suite
"""
import pytest
import os
import sys
from datetime import datetime, timedelta

# Add backend to path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# Import the existing Flask app
from app import app as flask_app
from database import get_db_connection, get_db_cursor, init_connection_pool
from werkzeug.security import generate_password_hash


@pytest.fixture(scope='session')
def app():
    """Get Flask application for testing"""
    flask_app.config.update({
        'TESTING': True,
        'DATABASE_URL': os.getenv('TEST_DATABASE_URL', os.getenv('DATABASE_URL', 'postgresql://localhost:5432/tarko_inventory')),
        'SECRET_KEY': 'test-secret-key',
        'JWT_SECRET_KEY': 'test-jwt-secret'
    })
    # Initialize connection pool
    init_connection_pool()
    yield flask_app


@pytest.fixture(scope='session')
def client(app):
    """Create test client"""
    return app.test_client()


@pytest.fixture(scope='session')
def runner(app):
    """Create CLI runner"""
    return app.test_cli_runner()


@pytest.fixture(scope='function')
def db_connection(app):
    """Create database connection for test"""
    with get_db_connection() as conn:
        yield conn
        conn.rollback()  # Rollback any changes after test


@pytest.fixture(scope='session', autouse=True)
def setup_test_database(app):
    """Setup test database before all tests"""
    # Setup phase
    with get_db_cursor(commit=True) as cursor:
        # Create or update test user (using pbkdf2:sha256 method compatible with Python 3.9)
        # First, try to get existing user
        cursor.execute("SELECT id FROM users WHERE email = %s", ('test@test.com',))
        user = cursor.fetchone()
        
        if user:
            # Update existing user's password
            user_id = user['id']
            cursor.execute("""
                UPDATE users 
                SET password_hash = %s, updated_at = %s
                WHERE id = %s
            """, (generate_password_hash('testpass123', method='pbkdf2:sha256'), datetime.now(), user_id))
        else:
            # Create new user
            cursor.execute("""
                INSERT INTO users (email, password_hash, created_at)
                VALUES (%s, %s, %s)
                RETURNING id
            """, ('test@test.com', generate_password_hash('testpass123', method='pbkdf2:sha256'), datetime.now()))
            user_id = cursor.fetchone()['id']
        
        # Ensure user has admin role
        cursor.execute("""
            INSERT INTO user_roles (user_id, role, created_at)
            VALUES (%s, %s, %s)
            ON CONFLICT (user_id, role) DO NOTHING
        """, (user_id, 'admin', datetime.now()))
        
        # Note: The existing seed data in schema.sql should provide:
        # - units (meters, kg, pieces, rolls)
        # - brands (Tarko Premium, Tarko Standard, Tarko Eco)
        # - locations (Main Warehouse, Plant Godown, Storage Yard)
        # - product_types (HDPE Pipe, Sprinkler Pipe)
        # Additional test data will be created by individual test fixtures

    yield

    # Cleanup phase after all tests
    with get_db_cursor(commit=True) as cursor:
        # Delete in order that respects foreign key constraints
        cursor.execute("DELETE FROM inventory_transactions WHERE 1=1")
        cursor.execute("DELETE FROM dispatch_items WHERE 1=1")
        cursor.execute("DELETE FROM dispatches WHERE 1=1")
        cursor.execute("DELETE FROM return_items WHERE 1=1")
        cursor.execute("DELETE FROM returns WHERE 1=1")
        cursor.execute("DELETE FROM scrap_records WHERE 1=1")
        cursor.execute("DELETE FROM spare_pieces WHERE 1=1")
        cursor.execute("DELETE FROM rolls WHERE 1=1")
        cursor.execute("DELETE FROM batches WHERE 1=1")
@pytest.fixture(scope='function')
def auth_token(client):
    """Get authentication token for tests"""
    response = client.post('/api/auth/login', json={
        'email': 'test@test.com',
        'password': 'testpass123'
    })
    if response.status_code != 200:
        raise Exception(f"Login failed: {response.json}")
    return response.json['access_token']


# ==================== PRODUCTION FIXTURES ====================

@pytest.fixture
def hdpe_batch(client, auth_token):
    """Create HDPE batch for testing"""
    response = client.post('/api/production/batch',
                          json={
                              'product_type_id': 1,
                              'brand_id': 1,
                              'parameters': {'diameter': '63mm', 'pressure': '10kg'},
                              'production_date': '2025-12-01T08:00:00',
                              'quantity': 1000,
                              'number_of_rolls': 2,
                              'length_per_roll': 500,
                              'weight_per_meter': 1.5
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def hdpe_batch_with_cuts(client, auth_token):
    """Create HDPE batch with cut rolls"""
    response = client.post('/api/production/batch',
                          json={
                              'product_type_id': 1,
                              'brand_id': 1,
                              'parameters': {'diameter': '50mm'},
                              'production_date': '2025-12-01T08:00:00',
                              'quantity': 600,
                              'number_of_rolls': 1,
                              'length_per_roll': 300,
                              'cut_rolls': [
                                  {'length': 150},
                                  {'length': 150}
                              ]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def sprinkler_batch(client, auth_token):
    """Create sprinkler batch for testing"""
    response = client.post('/api/production/batch',
                          json={
                              'product_type_id': 2,
                              'brand_id': 1,
                              'parameters': {'diameter': '32mm'},
                              'production_date': '2025-12-01T08:00:00',
                              'quantity': 215,
                              'quantity_based': True,
                              'roll_config_type': 'bundles',
                              'number_of_bundles': 20,
                              'bundle_size': 10,
                              'spare_pipes': [
                                  {'length': 7},
                                  {'length': 8}
                              ],
                              'length_per_roll': 6,
                              'weight_per_meter': 0.5
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def hdpe_batch_1(client, auth_token):
    """First HDPE batch for multi-batch tests"""
    response = client.post('/api/production/batch',
                          json={
                              'product_type_id': 1,
                              'brand_id': 1,
                              'parameters': {'diameter': '40mm'},
                              'production_date': '2025-12-01T08:00:00',
                              'quantity': 500,
                              'number_of_rolls': 1,
                              'length_per_roll': 500
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def hdpe_batch_2(client, auth_token):
    """Second HDPE batch for multi-batch tests"""
    response = client.post('/api/production/batch',
                          json={
                              'product_type_id': 1,
                              'brand_id': 1,
                              'parameters': {'diameter': '40mm'},
                              'production_date': '2025-12-01T09:00:00',
                              'quantity': 500,
                              'number_of_rolls': 1,
                              'length_per_roll': 500
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def batch_with_attachment(client, auth_token, tmpdir):
    """Create batch with file attachment"""
    from io import BytesIO

    # Create test file
    test_file = BytesIO(b'%PDF-1.4 test content')
    test_file.name = 'test_cert.pdf'

    response = client.post('/api/production/batch',
                          data={
                              'product_type_id': '1',
                              'brand_id': '1',
                              'parameters': '{}',
                              'production_date': '2025-12-01T08:00:00',
                              'quantity': '500',
                              'number_of_rolls': '1',
                              'length_per_roll': '500'
                          },
                          files={'attachment': (test_file.name, test_file, 'application/pdf')},
                          headers={'Authorization': f'Bearer {auth_token}'})
    result = response.json()
    result['filename'] = 'test_cert.pdf'
    return result


# ==================== DISPATCH FIXTURES ====================

@pytest.fixture
def dispatched_item(client, auth_token, hdpe_batch):
    """Create a dispatched item for testing"""
    response = client.post('/api/dispatch',
                          json={
                              'customer_name': 'Test Customer',
                              'customer_phone': '1234567890',
                              'dispatch_date': '2025-12-01T14:00:00',
                              'items': [{
                                  'batch_id': hdpe_batch['batch_id'],
                                  'item_id': hdpe_batch['rolls'][0]['id'],
                                  'quantity': 500,
                                  'unit_price': 100.00
                              }]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    result = response.json()
    result['item_id'] = result['items'][0]['id']
    result['quantity'] = 500
    return result


@pytest.fixture
def multi_item_dispatch(client, auth_token, hdpe_batch):
    """Create dispatch with multiple items"""
    response = client.post('/api/dispatch',
                          json={
                              'customer_name': 'Multi Item Customer',
                              'customer_phone': '9876543210',
                              'dispatch_date': '2025-12-01T14:00:00',
                              'items': [
                                  {
                                      'batch_id': hdpe_batch['batch_id'],
                                      'item_id': hdpe_batch['rolls'][0]['id'],
                                      'quantity': 300,
                                      'unit_price': 100.00
                                  },
                                  {
                                      'batch_id': hdpe_batch['batch_id'],
                                      'item_id': hdpe_batch['rolls'][1]['id'],
                                      'quantity': 200,
                                      'unit_price': 100.00
                                  }
                              ]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def mixed_batch_dispatch(client, auth_token, hdpe_batch_1, hdpe_batch_2):
    """Create dispatch from multiple batches"""
    response = client.post('/api/dispatch',
                          json={
                              'customer_name': 'Mixed Batch Customer',
                              'customer_phone': '5555555555',
                              'dispatch_date': '2025-12-01T14:00:00',
                              'items': [
                                  {
                                      'batch_id': hdpe_batch_1['batch_id'],
                                      'item_id': hdpe_batch_1['rolls'][0]['id'],
                                      'quantity': 250,
                                      'unit_price': 100.00
                                  },
                                  {
                                      'batch_id': hdpe_batch_2['batch_id'],
                                      'item_id': hdpe_batch_2['rolls'][0]['id'],
                                      'quantity': 250,
                                      'unit_price': 95.00
                                  }
                              ]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def cancelled_dispatch(client, auth_token, hdpe_batch):
    """Create and cancel a dispatch"""
    # Create dispatch
    dispatch_resp = client.post('/api/dispatch',
                                json={
                                    'customer_name': 'Cancelled Customer',
                                    'customer_phone': '1111111111',
                                    'dispatch_date': '2025-12-01T14:00:00',
                                    'items': [{
                                        'batch_id': hdpe_batch['batch_id'],
                                        'item_id': hdpe_batch['rolls'][0]['id'],
                                        'quantity': 200,
                                        'unit_price': 100.00
                                    }]
                                },
                                headers={'Authorization': f'Bearer {auth_token}'})
    dispatch = dispatch_resp.json()

    # Cancel it
    client.post(f'/api/dispatch/{dispatch["dispatch_id"]}/cancel',
               json={'reason': 'Test cancellation'},
               headers={'Authorization': f'Bearer {auth_token}'})

    return dispatch


@pytest.fixture
def hdpe_dispatch(client, auth_token, hdpe_batch):
    """Simple HDPE dispatch fixture"""
    response = client.post('/api/dispatch',
                          json={
                              'customer_name': 'HDPE Customer',
                              'customer_phone': '2223334444',
                              'dispatch_date': '2025-12-01T14:00:00',
                              'items': [{
                                  'batch_id': hdpe_batch['batch_id'],
                                  'item_id': hdpe_batch['rolls'][0]['id'],
                                  'quantity': 500,
                                  'unit_price': 100.00
                              }]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def sprinkler_dispatch(client, auth_token, sprinkler_batch):
    """Simple sprinkler dispatch fixture"""
    response = client.post('/api/dispatch',
                          json={
                              'customer_name': 'Sprinkler Customer',
                              'customer_phone': '3334445555',
                              'dispatch_date': '2025-12-01T14:00:00',
                              'items': [{
                                  'batch_id': sprinkler_batch['batch_id'],
                                  'item_id': sprinkler_batch['bundles'][0]['id'],
                                  'quantity': 10,
                                  'unit_price': 50.00
                              }]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def cut_roll_dispatch(client, auth_token, hdpe_batch_with_cuts):
    """Dispatch from cut roll"""
    response = client.post('/api/dispatch',
                          json={
                              'customer_name': 'Cut Roll Customer',
                              'customer_phone': '4445556666',
                              'dispatch_date': '2025-12-01T14:00:00',
                              'items': [{
                                  'batch_id': hdpe_batch_with_cuts['batch_id'],
                                  'item_id': hdpe_batch_with_cuts['cut_rolls'][0]['id'],
                                  'quantity': 150,
                                  'unit_price': 100.00
                              }]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def sprinkler_spare_dispatch(client, auth_token, sprinkler_batch):
    """Dispatch sprinkler spare pieces"""
    response = client.post('/api/dispatch',
                          json={
                              'customer_name': 'Spare Dispatch Customer',
                              'customer_phone': '5556667777',
                              'dispatch_date': '2025-12-01T14:00:00',
                              'items': [{
                                  'batch_id': sprinkler_batch['batch_id'],
                                  'item_id': sprinkler_batch['spare_pieces'][0]['id'],
                                  'quantity': 5,
                                  'unit_price': 50.00
                              }]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


# ==================== RETURN FIXTURES ====================

@pytest.fixture
def completed_return(client, auth_token, dispatched_item):
    """Create a completed return"""
    response = client.post('/api/returns',
                          json={
                              'dispatch_id': dispatched_item['dispatch_id'],
                              'return_date': '2025-12-02T10:00:00',
                              'items': [{
                                  'dispatch_item_id': dispatched_item['item_id'],
                                  'quantity': dispatched_item['quantity'],
                                  'reason': 'Complete return'
                              }]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def partial_return(client, auth_token, dispatched_item):
    """Create a partial return"""
    response = client.post('/api/returns',
                          json={
                              'dispatch_id': dispatched_item['dispatch_id'],
                              'return_date': '2025-12-02T10:00:00',
                              'items': [{
                                  'dispatch_item_id': dispatched_item['item_id'],
                                  'quantity': dispatched_item['quantity'] / 2,
                                  'reason': 'Partial return'
                              }]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


@pytest.fixture
def reverted_return(client, auth_token, completed_return):
    """Create and revert a return"""
    response = client.post(f'/api/returns/{completed_return["return_id"]}/revert',
                          json={'reason': 'Test revert'},
                          headers={'Authorization': f'Bearer {auth_token}'})
    return completed_return


@pytest.fixture
def sample_return(client, auth_token, dispatched_item):
    """Generic return fixture"""
    response = client.post('/api/returns',
                          json={
                              'dispatch_id': dispatched_item['dispatch_id'],
                              'return_date': '2025-12-02T10:00:00',
                              'items': [{
                                  'dispatch_item_id': dispatched_item['item_id'],
                                  'quantity': 100,
                                  'reason': 'Sample return'
                              }]
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


# ==================== SCRAP FIXTURES ====================

@pytest.fixture
def sample_scrap(client, auth_token, hdpe_batch):
    """Create a sample scrap record"""
    response = client.post('/api/scrap',
                          json={
                              'item_id': hdpe_batch['rolls'][0]['id'],
                              'batch_id': hdpe_batch['batch_id'],
                              'scrap_date': '2025-12-01T15:00:00',
                              'quantity': 100,
                              'reason': 'Sample scrap',
                              'scrap_type': 'production'
                          },
                          headers={'Authorization': f'Bearer {auth_token}'})
    return response.json()


# ==================== GENERAL FIXTURES ====================

@pytest.fixture
def sample_batch_id(hdpe_batch):
    """Get a sample batch ID"""
    return hdpe_batch['batch_id']


@pytest.fixture
def sample_dispatch(dispatched_item):
    """Get a sample dispatch"""
    return dispatched_item
