import { useState, useMemo } from 'react';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { SearchableCombobox } from './SearchableCombobox';
import { X, Package, Scissors, Plus, Minus, Check, Box, ChevronDown, ChevronUp, Package2 } from 'lucide-react';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { CutRollDialog } from '../inventory/CutRollDialog';
import { SplitBundleDialog } from '../inventory/SplitBundleDialog';
import { CombineSparesDialog } from '../inventory/CombineSparesDialog';

interface StockEntry {
  stock_id: string;
  stock_type: 'FULL_ROLL' | 'CUT_ROLL' | 'BUNDLE' | 'SPARE';
  quantity: number;
  length_per_unit?: number;
  pieces_per_bundle?: number;
  piece_length_meters?: number;
  piece_count?: number;
  piece_id?: string;
  spare_id?: string;
}

interface ProductVariant {
  variant_key: string;
  brand_name: string;
  product_type_name: string;
  product_category: string;
  parameters: Record<string, unknown>;
  stock_entries: StockEntry[];
}

interface ProductType {
  id: string;
  name: string;
}

interface ProductSelectionProps {
  productTypeId: string;
  onProductTypeChange: (id: string) => void;
  productSearch: string;
  onProductSearchChange: (search: string) => void;
  selectedRolls: any[];
  onRemoveRoll: (index: number) => void;
  onAddRoll: (roll: any) => void;
  onUpdateRollQuantity: (index: number, quantity: number, dispatchLength?: number) => void;
  productTypes: ProductType[];
  availableRolls: any[];
  onSearchProducts: () => void;
  productTypeRef?: React.RefObject<HTMLDivElement>;
  productSearchRef?: React.RefObject<HTMLDivElement>;
}

export const ProductSelectionSection = ({
  productTypeId,
  onProductTypeChange,
  productSearch,
  onProductSearchChange,
  selectedRolls,
  onRemoveRoll,
  onAddRoll,
  productTypes,
  availableRolls,
  productTypeRef,
  productSearchRef
}: ProductSelectionProps) => {
  const [quantityInputs, setQuantityInputs] = useState<Record<string, number>>({});

  // Group by brand + parameters + stock_type
  const groupedProducts = useMemo(() => {
    const groups: Record<string, ProductGroup> = {};

    availableRolls.forEach((roll) => {
      const paramStr = JSON.stringify(roll.parameters || {});
      const stockType = roll.stock_type || (roll.is_cut_roll ? 'CUT_ROLL' : roll.bundle_type === 'bundle' ? 'BUNDLE' : roll.bundle_type === 'spare' ? 'SPARE' : 'FULL_ROLL');
      const key = `${roll.brand_name}-${paramStr}-${stockType}`;

      if (!groups[key]) {
        groups[key] = {
          product_key: key,
          brand_name: roll.brand_name || '',
          parameters: roll.parameters || {},
          product_category: roll.product_category || 'HDPE',
          stock_type: stockType,
          full_rolls_count: 0,
          full_rolls_total_meters: 0,
          cut_rolls_count: 0,
          cut_rolls_total_meters: 0,
          bundles_count: 0,
          bundles_total_pieces: 0,
          bundle_size: 0,
          spares_count: 0,
          spares_total_pieces: 0,
          items: []
        };
      }

      const group = groups[key];
      group.items.push(roll);

      if (stockType === 'FULL_ROLL') {
        group.full_rolls_count += roll.quantity || 1;
        group.full_rolls_total_meters += (roll.length_meters || 0) * (roll.quantity || 1);
      } else if (stockType === 'CUT_ROLL') {
        group.cut_rolls_count += roll.quantity || 1;
        group.cut_rolls_total_meters += (roll.length_meters || 0) * (roll.quantity || 1);
      } else if (stockType === 'BUNDLE') {
        group.bundles_count += roll.quantity || 1;
        group.bundles_total_pieces += (roll.piece_count || 0);
        group.bundle_size = roll.bundle_size || 0;
      } else if (stockType === 'SPARE') {
        group.spares_count += roll.quantity || 1;
        group.spares_total_pieces += (roll.piece_count || 0);
      }
    });

    return Object.values(groups);
  }, [availableRolls]);

  // Filter grouped products
  const filteredProducts = useMemo(() => {
    if (!productSearch.trim()) return groupedProducts;

    const searchLower = productSearch.toLowerCase();
    return groupedProducts.filter(product => {
      const brandName = product.brand_name?.toLowerCase() || '';
      const params = JSON.stringify(product.parameters).toLowerCase();
      return brandName.includes(searchLower) || params.includes(searchLower);
    });
  }, [groupedProducts, productSearch]);

  // Format product name from parameters
  const getProductDisplayName = (product: ProductGroup) => {
    const params = product.parameters || {};
    const parts = [];

    if (params.outer_diameter) parts.push(`${params.outer_diameter}mm`);
    if (params.material) parts.push(params.material);
    if (params.pressure_class) parts.push(params.pressure_class);

    const specs = parts.join(' ');
    return specs ? `${specs} - ${product.brand_name}` : product.brand_name;
  };

  const handleQuantityChange = (key: string, value: number) => {
    setQuantityInputs(prev => ({ ...prev, [key]: Math.max(0, value) }));
  };

  const handleAddItems = (product: ProductGroup) => {
    const key = product.product_key;
    const quantity = quantityInputs[key] || 0;
    
    if (quantity <= 0) return;
    
    // Get the first item as template (they're all the same product)
    const templateItem = product.items[0];
    if (templateItem) {
      // Add with specified quantity
      onAddRoll({ ...templateItem, quantity });
      // Reset quantity input
      setQuantityInputs(prev => ({ ...prev, [key]: 0 }));
    }
  };

  return (
    <div className="space-y-4 p-4 border rounded-lg">
      <h3 className="font-semibold text-lg flex items-center gap-2">
        <Package className="h-5 w-5" />
        Product Selection
      </h3>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div ref={productTypeRef}>
          <Label>Product Type *</Label>
          <SearchableCombobox
            value={productTypeId}
            onChange={onProductTypeChange}
            options={productTypes}
            placeholder="Select product type"
            displayFormat={(pt) => pt.name}
          />
        </div>

        <div ref={productSearchRef}>
          <Label>Filter Products</Label>
          <Input
            value={productSearch}
            onChange={(e) => onProductSearchChange(e.target.value)}
            placeholder="Search by brand or specs..."
            className="w-full"
          />
          <p className="text-xs text-gray-500 mt-1">
            Showing {filteredProducts.length} product{filteredProducts.length !== 1 ? 's' : ''}
          </p>
        </div>
      </div>

      {/* Grouped Products */}
      {filteredProducts.length > 0 && (
        <div className="mt-4">
          <h4 className="font-medium mb-3 text-sm text-gray-700">
            Available Products ({filteredProducts.length})
          </h4>
          <div className="space-y-3 max-h-[500px] overflow-y-auto">
            {filteredProducts.map((product) => {
              const key = product.product_key;
              const inputValue = quantityInputs[key] || 0;
              
              // Determine max available and unit
              let maxAvailable = 0;
              let unit = '';
              let totalInfo = '';
              let icon = <Package className="h-5 w-5" />;
              let bgColor = 'bg-blue-50';
              let borderColor = 'border-blue-200';

              if (product.stock_type === 'FULL_ROLL') {
                maxAvailable = product.full_rolls_count;
                unit = 'roll';
                totalInfo = `${product.full_rolls_total_meters.toFixed(0)}m total`;
                icon = <Package className="h-5 w-5 text-blue-600" />;
              } else if (product.stock_type === 'CUT_ROLL') {
                maxAvailable = product.cut_rolls_count;
                unit = 'piece';
                totalInfo = `${product.cut_rolls_total_meters.toFixed(1)}m total`;
                icon = <Scissors className="h-5 w-5 text-orange-600" />;
                bgColor = 'bg-orange-50';
                borderColor = 'border-orange-200';
              } else if (product.stock_type === 'BUNDLE') {
                maxAvailable = product.bundles_count;
                unit = 'bundle';
                totalInfo = `${product.bundles_total_pieces} pieces (${product.bundle_size}/bundle)`;
                icon = <Package className="h-5 w-5 text-green-600" />;
                bgColor = 'bg-green-50';
                borderColor = 'border-green-200';
              } else if (product.stock_type === 'SPARE') {
                maxAvailable = product.spares_count;
                unit = 'group';
                totalInfo = `${product.spares_total_pieces} pieces total`;
                icon = <Package className="h-5 w-5 text-purple-600" />;
                bgColor = 'bg-purple-50';
                borderColor = 'border-purple-200';
              }

              return (
                <div
                  key={key}
                  className={`p-4 ${bgColor} border-2 ${borderColor} rounded-lg transition-all hover:shadow-md`}
                >
                  <div className="flex items-start justify-between gap-4">
                    {/* Product Info */}
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        {icon}
                        <div className="font-semibold text-base truncate">
                          {getProductDisplayName(product)}
                        </div>
                      </div>
                      <div className="text-sm text-gray-600 flex flex-wrap gap-2 items-center">
                        <Badge variant="outline" className="text-xs">
                          {product.stock_type.replace('_', ' ')}
                        </Badge>
                        <span>{totalInfo}</span>
                      </div>
                    </div>

                    {/* Quantity Controls */}
                    <div className="flex items-center gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleQuantityChange(key, inputValue - 1)}
                        disabled={inputValue <= 0}
                        className="h-8 w-8 p-0"
                      >
                        <Minus className="h-3 w-3" />
                      </Button>
                      
                      <Input
                        type="number"
                        value={inputValue}
                        onChange={(e) => handleQuantityChange(key, parseInt(e.target.value) || 0)}
                        className="w-16 h-8 text-center"
                        min="0"
                        max={maxAvailable}
                      />
                      
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleQuantityChange(key, inputValue + 1)}
                        disabled={inputValue >= maxAvailable}
                        className="h-8 w-8 p-0"
                      >
                        <Plus className="h-3 w-3" />
                      </Button>

                      <Button
                        onClick={() => handleAddItems(product)}
                        disabled={inputValue <= 0 || inputValue > maxAvailable}
                        size="sm"
                        className="ml-2 h-8"
                      >
                        <Check className="h-4 w-4 mr-1" />
                        Add
                      </Button>
                    </div>
                  </div>
                  
                  <div className="mt-2 text-xs text-gray-500">
                    Available: {maxAvailable} {unit}{maxAvailable !== 1 ? 's' : ''}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Selected Rolls */}
      {selectedRolls.length > 0 && (
        <div className="mt-4">
          <h4 className="font-medium mb-2 flex items-center justify-between">
            <span>Selected Items ({selectedRolls.length})</span>
            {selectedRolls.some(r => r.product_category === 'HDPE') && (
              <span className="text-sm text-gray-600">
                Total: {selectedRolls
                  .filter(r => r.product_category === 'HDPE')
                  .reduce((sum, r) => sum + (r.length_meters || 0) * (r.quantity || 1), 0)
                  .toFixed(2)}m
              </span>
            )}
          </h4>
          <div className="space-y-2 max-h-60 overflow-y-auto border rounded-lg p-2 bg-blue-50">
            {selectedRolls.map((roll, idx) => (
              <div
                key={idx}
                className="flex items-center justify-between p-2 bg-white border border-blue-200 rounded"
              >
                <div className="flex-1">
                  <div className="font-medium text-sm">{roll.brand_name} - {roll.product_type_name}</div>
                  <div className="text-xs text-gray-600 flex items-center gap-2">
                    <Badge variant="outline" className="text-xs">
                      Qty: {roll.quantity}
                    </Badge>
                    {roll.product_category === 'HDPE' && (
                      <>
                        <span>{roll.length_meters}m each</span>
                        {roll.is_cut_roll && <span>â€¢ Cut Roll</span>}
                      </>
                    )}
                    {roll.product_category === 'SPRINKLER' && (
                      <>
                        {roll.bundle_type === 'bundle' && <span>Bundle {roll.bundle_size}</span>}
                        {roll.bundle_type === 'spare' && <span>Spare - {roll.piece_count} pieces</span>}
                      </>
                    )}
                  </div>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => onRemoveRoll(idx)}
                  className="text-red-500 hover:text-red-700 hover:bg-red-50 h-8 w-8 p-0"
                >
                  <X className="h-4 w-4" />
                </Button>
              </div>
            ))}
          </div>
        </div>
      )}

      {filteredProducts.length === 0 && availableRolls.length > 0 && (
        <div className="text-center py-8 text-gray-500">
          <Package className="h-12 w-12 mx-auto mb-2 opacity-30" />
          <p>No products match your filter</p>
        </div>
      )}

      {availableRolls.length === 0 && productTypeId && (
        <div className="text-center py-8 text-gray-500">
          <Package className="h-12 w-12 mx-auto mb-2 opacity-30" />
          <p>No available products for this type</p>
        </div>
      )}
    </div>
  );
};